<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Plagas Profesional | SICSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Fondo muy claro */
        }
        /* Estilo para los iconos SVG */
        .icon-svg {
            width: 3rem;
            height: 3rem;
        }
        /* Estilos específicos para el chatbot */
        #chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        #chat-window {
            width: 90vw;
            max-width: 380px;
            height: 75vh;
            max-height: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            overflow: hidden;
        }
        #chat-button {
            transition: transform 0.2s ease;
        }
        #chat-button:hover {
            transform: scale(1.05);
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        /* Ocultar scrollbar en contenedor de mensajes */
        #messages-container::-webkit-scrollbar {
            display: none;
        }
        #messages-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10B981', /* Emerald Green - Confianza y Naturaleza */
                        'secondary-dark': '#1F2937', /* Dark Gray - Profesionalismo */
                        'accent-blue': '#3B82F6', /* Blue for CTAs */
                        'bot-bubble': '#E0F2F1', /* Light green for bot */
                        'user-bubble': '#3B82F6', /* Blue for user */
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased text-secondary-dark">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="text-3xl font-extrabold text-primary-green tracking-tight">
                SICSA
            </div>
            <nav class="hidden md:flex space-x-8 text-sm font-medium">
                <a href="#servicios" class="hover:text-primary-green transition duration-300">Servicios</a>
                <a href="#ventajas" class="hover:text-primary-green transition duration-300">Ventajas</a>
                <a href="#testimonios" class="hover:text-primary-green transition duration-300">Testimonios</a>
                <a href="#contacto" class="hover:text-primary-green transition duration-300">Contacto</a>
            </nav>
            <a href="#contacto" class="hidden md:block bg-accent-blue text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 transition duration-300 shadow-lg">
                ¡Pedir Presupuesto!
            </a>
            <button class="md:hidden p-2 text-secondary-dark hover:text-primary-green rounded-lg transition duration-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
    </header>

    <section class="relative bg-white pt-16 pb-20 md:pt-24 md:pb-32 overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid md:grid-cols-2 gap-12 items-center">
            <div>
                <span class="text-sm font-semibold text-primary-green uppercase tracking-wider mb-3 block">Su tranquilidad es nuestra misión</span>
                <h1 class="text-5xl md:text-6xl font-extrabold leading-tight mb-6">
                    Elimine las plagas <span class="text-primary-green">de forma segura</span> y definitiva.
                </h1>
                <p class="text-xl text-gray-600 mb-8">
                    Soluciones profesionales de control de plagas para hogares y negocios. Utilizamos métodos ecológicos y garantizamos resultados a largo plazo.
                </p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <a href="#contacto" class="w-full sm:w-auto text-center bg-primary-green text-white py-3 px-8 rounded-xl text-lg font-bold hover:bg-emerald-600 transition duration-300 shadow-xl shadow-primary-green/30 transform hover:scale-[1.02]">
                        ¡Solicitar Inspección Gratuita!
                    </a>
                    <a href="tel:+525574000017" class="w-full sm:w-auto text-center bg-gray-200 text-secondary-dark py-3 px-8 rounded-xl text-lg font-bold hover:bg-gray-300 transition duration-300">
                        Llamar/WhatsApp (+52 5574000017)
                    </a>
                </div>
            </div>

            <div class="hidden md:block">
                <div class="bg-primary-green/10 rounded-3xl p-6 shadow-2xl shadow-primary-green/20">
                    <img src="https://placehold.co/600x400/10B981/ffffff?text=T%C3%A9cnico+Profesional" alt="Técnico de control de plagas inspeccionando" class="rounded-2xl w-full object-cover">
                </div>
            </div>
        </div>
    </section>

    <section id="servicios" class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-4xl font-extrabold mb-4">Nuestros Servicios de Control</h2>
            <p class="text-lg text-gray-600 mb-12 max-w-3xl mx-auto">
                Ofrecemos soluciones especializadas para todo tipo de invasores no deseados, garantizando un entorno seguro y limpio.
            </p>

            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 border-t-4 border-primary-green">
                    <svg class="icon-svg mx-auto mb-4 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2zM6.5 10H17.5M8 6h8M8 14h8"></path></svg>
                    <h3 class="text-xl font-bold mb-3">Insectos Rastreadores</h3>
                    <p class="text-gray-500">Eliminación de hormigas, cucarachas, arañas y otros insectos que invaden su espacio.</p>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 border-t-4 border-primary-green">
                    <svg class="icon-svg mx-auto mb-4 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-3a8 8 0 00-8 8m-3-3l-2-2m0 0l-2-2m2 2l2-2m-2 2l-2 2m4 4h.01M16 4h.01M19 12h.01M12 19h.01M5 12h.01M12 5h.01"></path></svg>
                    <h3 class="text-xl font-bold mb-3">Control de Roedores</h3>
                    <p class="text-gray-500">Programas efectivos para la erradicación de ratas y ratones, incluyendo sellado y prevención.</p>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-1 border-t-4 border-primary-green">
                    <svg class="icon-svg mx-auto mb-4 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    <h3 class="text-xl font-bold mb-3">Plagas Voladoras</h3>
                    <p class="text-gray-500">Tratamiento para mosquitos, moscas, avispas y control de termitas para proteger su estructura.</p>
                </div>
            </div>

            <div class="mt-12">
                <a href="#contacto" class="bg-accent-blue text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-blue-600 transition duration-300 shadow-md">
                    Ver Todos los Servicios
                </a>
            </div>
        </div>
    </section>

    <section id="ventajas" class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl font-extrabold mb-4">¿Por Qué Elegir a SICSA?</h2>
                <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                    Nos enfocamos en su bienestar y la protección de su propiedad con la máxima calidad y seguridad.
                </p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="text-center p-6 border rounded-xl shadow-sm">
                    <div class="bg-primary-green/10 inline-flex p-3 rounded-full mb-4">
                        <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.01 12.01 0 002.944 12c-.144 1.346.066 2.684.606 3.948"></path></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Seguridad Garantizada</h3>
                    <p class="text-gray-500 text-sm">Usamos productos certificados, seguros para niños y mascotas.</p>
                </div>

                <div class="text-center p-6 border rounded-xl shadow-sm">
                    <div class="bg-primary-green/10 inline-flex p-3 rounded-full mb-4">
                        <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.86-1.742 7.17-4.225 9.17-2.483-2.003-4.225-5.31-4.225-9.17 0-5.523 4.477-10 10-10s10 4.477 10 10z"></path></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Técnicos Expertos</h3>
                    <p class="text-gray-500 text-sm">Equipo altamente capacitado y con años de experiencia en el sector.</p>
                </div>

                <div class="text-center p-6 border rounded-xl shadow-sm">
                    <div class="bg-primary-green/10 inline-flex p-3 rounded-full mb-4">
                        <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Atención Inmediata</h3>
                    <p class="text-gray-500 text-sm">Respuesta en menos de 24 horas y flexibilidad en horarios de servicio.</p>
                </div>

                <div class="text-center p-6 border rounded-xl shadow-sm">
                    <div class="bg-primary-green/10 inline-flex p-3 rounded-full mb-4">
                        <svg class="w-8 h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0h.01"></path></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Solución a Domicilio</h3>
                    <p class="text-gray-500 text-sm">Servicio residencial, comercial e industrial. Cubrimos su área.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="testimonios" class="py-20 bg-primary-green/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-4xl font-extrabold mb-4">Lo que Dicen Nuestros Clientes</h2>
            <p class="text-lg text-gray-600 mb-12 max-w-3xl mx-auto">
                La satisfacción de nuestros clientes es nuestra mejor carta de presentación.
            </p>

            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary-green text-left">
                    <p class="text-4xl font-serif text-gray-400 mb-2">“</p>
                    <p class="text-gray-700 italic mb-4">"El servicio fue rápido y totalmente discreto. Por fin me deshice del problema de roedores. 100% recomendados por su profesionalismo."</p>
                    <div class="font-semibold text-secondary-dark">- Ana L. (Residencial)</div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary-green text-left">
                    <p class="text-4xl font-serif text-gray-400 mb-2">“</p>
                    <p class="text-gray-700 italic mb-4">"SICSA es la única empresa que ha logrado controlar las plagas en nuestro restaurante. Sus métodos son efectivos y amigables con el medio ambiente."</p>
                    <div class="font-semibold text-secondary-dark">- Javier G. (Restaurante)</div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary-green text-left">
                    <p class="text-4xl font-serif text-gray-400 mb-2">“</p>
                    <p class="text-gray-700 italic mb-4">"Desde la inspección inicial hasta la aplicación, todo fue transparente y claro. Ya no encontramos arañas en la bodega. ¡Excelente trabajo!"</p>
                    <div class="font-semibold text-secondary-dark">- Marco P. (Comercial)</div>
                </div>
            </div>
        </div>
    </section>

    <section id="contacto" class="py-20 bg-white">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-secondary-dark text-white p-8 md:p-12 rounded-2xl shadow-2xl grid md:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="text-4xl font-extrabold mb-4 text-primary-green">Su Solución Empieza Aquí.</h2>
                    <p class="text-xl text-gray-300 mb-6">
                        Contáctenos hoy para una inspección sin compromiso. Nuestro equipo responderá rápidamente para proteger su propiedad.
                    </p>
                    <div class="space-y-4">
                        <a href="https://wa.me/525574000017" target="_blank" class="flex items-center text-lg text-primary-green hover:underline">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-11a2 2 0 01-2-2v-14z"></path></svg>
                            +52 5574000017 (WhatsApp)
                        </a>
                        <p class="flex items-center text-lg">
                            <svg class="w-6 h-6 mr-3 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            sicsamanejointegradodeplagas@gmail.com
                        </p>
                        <p class="flex items-center text-lg">
                            <svg class="w-6 h-6 mr-3 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Av. Principal 123, Ciudad, País
                        </p>
                    </div>
                </div>

                <form id="contact-form" class="space-y-4 bg-white p-6 rounded-xl shadow-2xl">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-secondary-dark">Nombre Completo</label>
                        <input type="text" id="nombre" name="nombre" placeholder="Juan Pérez" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primary-green focus:border-primary-green text-secondary-dark" required>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-secondary-dark">Teléfono</label>
                        <input type="tel" id="telefono" name="telefono" placeholder="(55) 5555-5555" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primary-green focus:border-primary-green text-secondary-dark" required>
                    </div>
                    <div>
                        <label for="servicio" class="block text-sm font-medium text-secondary-dark">Tipo de Plaga (Opcional)</label>
                        <select id="servicio" name="servicio" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primary-green focus:border-primary-green text-secondary-dark">
                            <option value="">Seleccione...</option>
                            <option value="Cucarachas">Cucarachas</option>
                            <option value="Roedores">Roedores</option>
                            <option value="Termitas">Termitas</option>
                            <option value="Otras Plagas">Otras Plagas</option>
                        </select>
                    </div>
                    <div>
                        <label for="mensaje" class="block text-sm font-medium text-secondary-dark">Detalles del Problema</label>
                        <textarea id="mensaje" name="mensaje" rows="3" placeholder="Por favor, describa brevemente su situación..." class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-primary-green focus:border-primary-green text-secondary-dark" required></textarea>
                    </div>
                    <button type="submit" id="submit-contact-form" class="w-full bg-accent-blue text-white py-3 rounded-xl font-bold text-lg hover:bg-blue-600 transition duration-300 shadow-lg shadow-accent-blue/30">
                        Enviar Solicitud por WhatsApp
                    </button>
                    <p id="form-message" class="text-sm text-center text-primary-green font-semibold hidden"></p>
                    <p class="text-xs text-center text-gray-500 mt-3">Su información está 100% segura y nunca será compartida.</p>
                </form>
            </div>
        </div>
    </section>

    <footer class="bg-secondary-dark py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
            <div class="text-xl font-extrabold text-primary-green tracking-tight mb-3">
                SICSA
            </div>
            <p class="text-sm">&copy; 2024 SICSA Control de Plagas. Todos los derechos reservados.</p>
            <div class="mt-4 space-x-4 text-sm">
                <a href="#" class="hover:text-primary-green transition duration-300">Política de Privacidad</a>
                <span class="text-gray-600">|</span>
                <a href="#" class="hover:text-primary-green transition duration-300">Términos del Servicio</a>
            </div>
        </div>
    </footer>

    <div id="chat-widget">
        <div id="chat-window" class="bg-white">
            <div class="bg-primary-green text-white p-4 rounded-t-xl flex justify-between items-center">
                <h3 class="text-lg font-bold">Asistente SICSA</h3>
                <button id="close-chat-btn" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                </div>

            <form id="chat-form" class="p-4 border-t border-gray-200 bg-white">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Escribe tu nombre para empezar..." class="flex-1 border border-gray-300 rounded-lg p-3 text-sm focus:ring-primary-green focus:border-primary-green" autocomplete="off" required>
                    <button type="submit" id="send-btn" class="bg-accent-blue text-white p-3 rounded-lg hover:bg-blue-600 transition duration-300 disabled:bg-gray-400" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </form>
        </div>

        <button id="chat-button" class="mt-4 w-16 h-16 rounded-full bg-primary-green text-white flex items-center justify-center shadow-2xl hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-primary-green/50">
            <svg id="chat-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path></svg>
        </button>
    </div>

    <script type="module">
        // --- Constantes de la API y Configuración del Chat ---
        // **IMPORTANTE**: La comunicación ahora se dirige al endpoint de Flask /chat
        const CHAT_ENDPOINT = "/chat";
        const LEAD_ENDPOINT = "/save_lead"; // Nuevo endpoint para guardar leads
        
        const WHATSAPP_NUMBER = "+52 5574000017";
        const WHATSAPP_LINK = "https://wa.me/525574000017";
        const EMAIL = "sicsamanejointegradodeplagas@gmail.com";

        const SERVICE_OPTIONS = {
            '1': 'Insectos Rastreadores (cucarachas, hormigas, arañas)',
            '2': 'Roedores (ratas, ratones)',
            '3': 'Plagas Voladoras (mosquitos, moscas, termitas)',
            '4': 'Otro / No estoy seguro',
        };
        
        // Estado del cliente (persiste en localStorage)
        let userName = null;
        let userPhone = null;
        let userService = null;
        let chatHistory = [];

        // Estado del flujo de recolección de datos
        let isNameRequired = true; 
        let isPhoneRequired = false;
        let isServiceRequired = false;
        
        // --- Elementos del DOM ---
        const chatButton = document.getElementById('chat-button');
        const chatWindow = document.getElementById('chat-window');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const messagesContainer = document.getElementById('messages-container');
        const sendBtn = document.getElementById('send-btn');
        const chatHeader = document.querySelector('#chat-window h3');

        // --- Elementos del Formulario de Contacto ---
        const contactForm = document.getElementById('contact-form');
        const submitContactBtn = document.getElementById('submit-contact-form');
        const formMessage = document.getElementById('form-message');


        // --- Lógica de LocalStorage (Carga y Guardado) ---

        /** Carga la sesión de chat desde localStorage. */
        function loadDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('sicsaChatState');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    userName = data.userName;
                    userPhone = data.userPhone;
                    userService = data.userService;
                    chatHistory = data.history || [];
                }
            } catch (e) {
                console.error("Error al cargar datos de localStorage:", e);
            }

            // Definir el estado de requerimiento basado en los datos cargados
            isNameRequired = !userName;
            isPhoneRequired = userName && !userPhone;
            isServiceRequired = userName && userPhone && !userService;

            messagesContainer.innerHTML = ''; // Limpiar mensajes

            // Renderizar historial
            chatHistory.forEach(msg => addMessage(msg.text, msg.role, false));

            // Si no se requiere nada, el chat está listo
            if (!isNameRequired && !isPhoneRequired && !isServiceRequired) {
                // Si el chat ya está listo, y no hay historial, damos la bienvenida
                if (chatHistory.length === 0) {
                    const welcomeMsg = `¡Hola de nuevo, ${userName}! Ya tengo tus datos (Teléfono: ${userPhone}, Servicio: ${userService}). Estoy listo para ayudarte. ¿Cuál es tu consulta?`;
                    addMessage(welcomeMsg, 'bot', true); // Se guarda en el historial de chatHistory
                }
            } else if (chatHistory.length === 0) {
                // Si no está listo y no hay historial, mandar el primer mensaje de solicitud de nombre
                 addMessage("¡Hola! Soy tu Asistente de SICSA. Para ofrecerte una atención personalizada, ¿podrías decirme tu **nombre**?", 'bot', false);
            }
            
            scrollToBottom();
            updateChatInterface();
        }

        /** * Guarda el estado actual de la sesión en localStorage.
         * @param {object} data - Datos opcionales para actualizar (userName, userPhone, userService).
         */
        function saveDataToLocalStorage(data = {}) {
            // Actualizar el estado local con los nuevos datos antes de guardar
            if (data.userName !== undefined) userName = data.userName;
            if (data.userPhone !== undefined) userPhone = data.userPhone;
            if (data.userService !== undefined) userService = data.userService;
            
            const dataToSave = {
                userName: userName,
                userPhone: userPhone,
                userService: userService,
                history: chatHistory
            };

            try {
                localStorage.setItem('sicsaChatState', JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Error al guardar datos de localStorage:", e);
            }
        }
        
        // --- Funciones del Chatbot ---

        /** Devuelve el mensaje de solicitud de servicio con opciones. */
        function getServicePrompt() {
            let prompt = "Perfecto. Ahora, para canalizarte con el experto adecuado, dime ¿cuál es el **tipo de servicio o plaga** que te interesa? \n\n**Opciones:**\n";
            for (const key in SERVICE_OPTIONS) {
                prompt += `**${key}**: ${SERVICE_OPTIONS[key]}\n`;
            }
            prompt += "\nPor favor, responde con el **número** de la opción que mejor describa tu necesidad (ej: `1`).";
            return prompt;
        }

        // Instrucción del Sistema para definir el rol del Chatbot
        const getSystemInstruction = (name, phone, service) => {
            const clientInfo = `Información del Cliente: Nombre: ${name || 'N/A'}, Teléfono: ${phone || 'N/A'}, Servicio Deseado: ${service || 'N/A'}.`;
            return `Actúa como un Asistente Virtual experto en Control de Plagas para la empresa SICSA. ${clientInfo} Tu objetivo es: 
            1. Responder preguntas sobre plagas comunes. 
            2. Explicar los servicios de SICSA y sus beneficios (seguridad, ecología, rapidez). 
            3. Dirigir al usuario a contacto humano proporcionando el número de WhatsApp ${WHATSAPP_NUMBER} y el enlace directo de WhatsApp: ${WHATSAPP_LINK}. También proporciona el correo electrónico ${EMAIL}. 
            Mantén las respuestas profesionales, amigables, concisas y siempre orientadas a la acción (contactar a SICSA). Tu respuesta debe ser solo en español.`;
        };


        /** Actualiza la interfaz de usuario basado en el estado. */
        function updateChatInterface() {
            let placeholderText = "Escribe tu mensaje...";
            let headerTitle = "Asistente SICSA";

            if (isNameRequired) {
                placeholderText = "Por favor, escribe tu nombre para empezar...";
                headerTitle = "¡Bienvenido! - Asistente SICSA";
            } else if (isPhoneRequired) {
                placeholderText = "Escribe tu número de contacto (ej: 5512345678)...";
                headerTitle = `Hola ${userName} - ¡Te estamos conociendo!`;
            } else if (isServiceRequired) {
                placeholderText = "Escribe el número de la opción de servicio (ej: 1)...";
                headerTitle = `Hola ${userName} - ¡Un paso más!`;
            } else if (userName) {
                 headerTitle = `Hola ${userName} - Asistente SICSA`;
            }

            chatHeader.textContent = headerTitle;
            userInput.placeholder = placeholderText;
            // Se habilita el botón si hay texto en el input (listener 'input' se encarga)
            sendBtn.disabled = userInput.value.trim() === ''; 
            userInput.focus();
        }

        /** Toglea la visibilidad de la ventana del chat. */
        function toggleChat() {
            chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
            if (chatWindow.style.display === 'flex') {
                scrollToBottom();
                updateChatInterface(); // Refrescar la UI al abrir
            }
        }

        /** Desplaza el contenedor de mensajes al final. */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Crea y añade una burbuja de mensaje al contenedor.
         * @param {string} text - El contenido del mensaje.
         * @param {string} sender - 'user' o 'bot'.
         * @param {boolean} updateHistory - Si el mensaje debe ser añadido al historial local.
         */
        function addMessage(text, sender, updateHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${sender === 'user' ? 'bg-user-bubble text-white' : 'bg-bot-bubble text-secondary-dark border border-gray-200'}`;
            
            // Reemplaza los enlaces de WhatsApp por un link estilizado
            if (sender === 'bot') {
                text = text.replace(WHATSAPP_LINK, `<a href="${WHATSAPP_LINK}" target="_blank" class="text-accent-blue font-bold hover:underline">Chat por WhatsApp</a>`);
            }
            
            messageBubble.innerHTML = text;
            
            messageWrapper.appendChild(messageBubble);
            messagesContainer.appendChild(messageWrapper);
            scrollToBottom();

            if (updateHistory) {
                // El rol 'model' es el que entiende la API de Gemini
                chatHistory.push({
                    role: sender === 'user' ? 'user' : 'model',
                    text: text,
                    time: new Date().toISOString()
                });
            }
        }

        /** * Llama al nuevo endpoint de Flask (/chat) para obtener la respuesta de Gemini. 
         * @param {string} query - El mensaje del usuario (ya está en el historial, pero se mantiene el parámetro por convención).
         */
        async function fetchGeminiResponse(query) {
            const maxRetries = 5;
            let delay = 1000;
            
            // Usar el historial de chat (formato para la API)
            const contents = chatHistory.map(msg => ({ 
                role: msg.role, 
                parts: [{ text: msg.text }] 
            }));
            
            const payload = {
                contents: contents,
                systemInstruction: getSystemInstruction(userName, userPhone, userService),
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(CHAT_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Respuesta exitosa de Flask y Gemini
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, tuve un problema al generar la respuesta.";
                        return text;
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Error de Rate Limiting, reintentar (Flask devolvería 429 si la API de Gemini lo hizo)
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        // console.warn(`Reintento de API N°${i + 1}...`); // Omitir logging en Canvas
                    } else {
                        // Otros errores (Flask devolvió un 4xx/5xx general)
                        const error_message = result.error || "Lo siento, el servidor reportó un error desconocido.";
                        console.error("Error del Servidor Flask:", result);
                        return `Error del Servidor: ${error_message}`;
                    }
                } catch (error) {
                    // console.error("Error en la solicitud fetch al endpoint de Flask:", error); // Omitir logging en Canvas
                    return "Error de conexión. Asegúrate de que el servidor Flask (`app.py`) esté corriendo.";
                }
            }
            return "Lo siento, el servicio está experimentando alta demanda. Por favor, inténtelo más tarde.";
        }
        
        // --- FUNCIÓN AGREGADA: Lógica para enviar el lead al servidor Flask ---
        async function saveLead(data) {
            try {
                const response = await fetch(LEAD_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Lead guardado con éxito:", result);
                    return true;
                } else {
                    console.error("Error al guardar el lead en el servidor:", response.statusText);
                    return false;
                }
            } catch (error) {
                console.error("Error de conexión al intentar guardar el lead:", error);
                // Permitimos que la ejecución continúe a WhatsApp incluso si falla el guardado
                return false; 
            }
        }


        // --- Lógica de envío del formulario de contacto (Redirección a WhatsApp) ---
        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitContactBtn.textContent = 'Procesando...';
            submitContactBtn.disabled = true;
            formMessage.textContent = 'Guardando datos y preparando WhatsApp...';
            formMessage.classList.remove('hidden');


            // 1. Recoger datos del formulario
            const nombre = document.getElementById('nombre').value;
            const telefono = document.getElementById('telefono').value;
            const selectElement = document.getElementById('servicio');
            const servicioValue = selectElement.value;
            const servicioTexto = selectElement.options[selectElement.selectedIndex].text;
            const mensaje = document.getElementById('mensaje').value;

            const leadData = {
                nombre: nombre,
                telefono: telefono,
                servicio: servicioTexto,
                mensaje: mensaje
            };

            // 2. LLAMADA CRÍTICA: Guardar el lead en el servidor Flask/PostgreSQL
            const saved = await saveLead(leadData);

            if (saved) {
                formMessage.textContent = '¡Datos guardados! Serás redirigido a WhatsApp para enviar tu solicitud...';
            } else {
                 formMessage.textContent = 'Error al guardar datos, pero redirigiendo a WhatsApp...';
            }


            // 3. Construir el mensaje de WhatsApp (independiente del resultado del guardado)
            const waMessage = `Hola, mi nombre es *${nombre}* y mi teléfono es *${telefono}*.\n\nEstoy interesado(a) en el servicio de: *${servicioTexto || 'No especificado'}*.\n\n*Detalles del problema:*\n${mensaje}`;
            
            // Codificar el mensaje para la URL
            const encodedMessage = encodeURIComponent(waMessage);

            // 4. Construir la URL de WhatsApp
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER.replace(/\s/g, '')}?text=${encodedMessage}`;
            
            // 5. Redirigir
            setTimeout(() => {
                window.open(whatsappUrl, '_blank');
                
                // Resetear el formulario después de la redirección
                contactForm.reset();
                submitContactBtn.textContent = 'Enviar Solicitud por WhatsApp';
                submitContactBtn.disabled = false;
                formMessage.classList.add('hidden');
            }, 1500); // 1.5 segundos de retraso para ver el mensaje
        });


        // --- Manejador Principal del Formulario de Chat ---

        // Habilita el botón de enviar solo si hay texto en el input
        userInput.addEventListener('input', () => {
            sendBtn.disabled = userInput.value.trim() === '';
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            userInput.value = '';
            sendBtn.disabled = true;
            userInput.placeholder = "Procesando...";

            // 1. CAPTURAR NOMBRE
            if (isNameRequired) {
                if (query.length < 2) {
                    addMessage("Por favor, ingresa un nombre válido.", 'bot');
                    // Deshacer el guardado del mensaje de usuario no válido
                    chatHistory = chatHistory.filter(msg => msg.role !== 'user' || msg.text !== query); 
                    sendBtn.disabled = false;
                    userInput.placeholder = "Por favor, escribe tu nombre para empezar...";
                    return;
                }

                isNameRequired = false;
                isPhoneRequired = true;

                saveDataToLocalStorage({ userName: query.split(' ')[0] }); 
                
                const nextPrompt = `¡Hola, **${userName}**! Gracias. Ahora, para poder dar seguimiento a tu caso, por favor, ingresa tu **número de contacto** (WhatsApp o móvil):`;
                addMessage(nextPrompt, 'bot');
                saveDataToLocalStorage(); 
                
                updateChatInterface(); 
                sendBtn.disabled = false;
                return;
            }

            // 2. CAPTURAR TELÉFONO
            if (isPhoneRequired) {
                if (query.length < 8 || !/^[0-9\s\-\+\(\)]+$/.test(query)) {
                    addMessage("Ese no parece un número de contacto válido. Por favor, ingresa un número de 8 a 15 dígitos para continuar.", 'bot');
                    // Deshacer el guardado del mensaje de usuario no válido
                    chatHistory = chatHistory.filter(msg => msg.role !== 'user' || msg.text !== query); 
                    sendBtn.disabled = false;
                    userInput.placeholder = "Por favor, ingresa un número válido...";
                    return;
                }
                
                isPhoneRequired = false;
                isServiceRequired = true;

                saveDataToLocalStorage({ userPhone: query }); 
                
                const nextPrompt = getServicePrompt();
                addMessage(nextPrompt, 'bot');
                saveDataToLocalStorage(); 
                
                updateChatInterface(); 
                sendBtn.disabled = false;
                return;
            }

            // 3. CAPTURAR SERVICIO
            if (isServiceRequired) {
                const serviceKey = query.trim().charAt(0); 
                
                if (!SERVICE_OPTIONS[serviceKey]) {
                    addMessage("Opción inválida. Por favor, ingresa solo el **número** (1, 2, 3 o 4) de la opción que deseas.", 'bot');
                    // Deshacer el guardado del mensaje de usuario no válido
                    chatHistory = chatHistory.filter(msg => msg.role !== 'user' || msg.text !== query); 
                    sendBtn.disabled = false;
                    userInput.placeholder = "Escribe el número de la opción (1-4)...";
                    return;
                }

                isServiceRequired = false;
                const selectedService = SERVICE_OPTIONS[serviceKey];

                saveDataToLocalStorage({ userService: selectedService }); 

                const finalWelcome = `¡Excelente! Ya tengo toda la información: **Nombre:** ${userName}, **Teléfono:** ${userPhone}, **Servicio:** ${selectedService}.
                \n\nTu información ha sido guardada localmente. Ahora, soy todo oídos. Dime, ¿cuál es tu consulta o qué detalles tienes sobre la plaga?`;
                
                addMessage(finalWelcome, 'bot');
                saveDataToLocalStorage(); 
                
                updateChatInterface(); 
                sendBtn.disabled = false;
                
                // NOTA: Podrías añadir la lógica de saveLead aquí también si quisieras guardar
                // los datos capturados en el chat, usando saveLead({ nombre: userName, telefono: userPhone, servicio: selectedService, mensaje: "Chatbot Lead" });
                
                return;
            }


            // MODO CONVERSACIÓN LIBRE (Gemini)
            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-indicator';
            loadingBubble.className = 'flex justify-start';
            loadingBubble.innerHTML = `<div class="message-bubble bg-bot-bubble text-secondary-dark border border-gray-200">...</div>`;
            messagesContainer.appendChild(loadingBubble);
            scrollToBottom();

            saveDataToLocalStorage(); // Guardar mensaje del usuario inmediatamente

            const botResponse = await fetchGeminiResponse(query);

            loadingBubble.remove();
            addMessage(botResponse, 'bot');

            saveDataToLocalStorage(); // Guardar mensaje del bot y el historial actualizado

            sendBtn.disabled = false;
            userInput.placeholder = "Escribe tu mensaje...";
            userInput.focus();
        });


        // --- Inicialización ---

        chatButton.addEventListener('click', toggleChat);
        closeChatBtn.addEventListener('click', toggleChat);

        // Cargar los datos guardados al inicio
        loadDataFromLocalStorage();

    </script>

</body>
</html>
